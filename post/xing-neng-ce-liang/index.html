<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>性能测量 | Han&#39;s 大吴疆土</title>

<link rel="shortcut icon" href="https://hanaeternum.github.io/favicon.ico?v=1767339667470">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://hanaeternum.github.io/styles/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script>
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <div class="navbar-brand">
        <img class="user-avatar" src="/images/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first">
            Han&#39;s 大吴疆土
        </div>
    </div>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
                <div class="nav-item">
                    
                        <a href="https://hanaeternum.github.io" class="menu gt-a-link">
                            首页
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/archives" class="menu gt-a-link">
                            归档
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/tags" class="menu gt-a-link">
                            标签
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="https://hanaeternum.github.io/post/you-lian" class="menu gt-a-link">
                            友链
                        </a>
                    
                </div>
            
                <div class="nav-item">
                    
                        <a href="/post/about" class="menu gt-a-link">
                            关于
                        </a>
                    
                </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1767339667470" action="/search/index.html">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    性能测量
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2025-12-25 ·
                    </time>
                    
                </div>
                <div class="post-content">
                    <p><ul class="markdownIt-TOC">
<li><a href="#%E5%A0%86%E6%A0%88%E4%BD%BF%E7%94%A8%E6%B5%8B%E9%87%8F">堆栈使用测量</a></li>
<li><a href="#cpu%E4%BD%BF%E7%94%A8%E7%99%BE%E5%88%86%E6%AF%94%E6%B5%8B%E9%87%8F">CPU使用百分比测量</a></li>
</ul>
</p>
<h1 id="堆栈使用测量">堆栈使用测量</h1>
<figure data-type="image" tabindex="1"><img src="https://hanaeternum.github.io/post-images/%E6%80%A7%E8%83%BD%E6%B5%8B%E9%87%8F/0.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="2"><img src="https://hanaeternum.github.io/post-images/%E6%80%A7%E8%83%BD%E6%B5%8B%E9%87%8F/1.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="3"><img src="https://hanaeternum.github.io/post-images/%E6%80%A7%E8%83%BD%E6%B5%8B%E9%87%8F/2.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="4"><img src="https://hanaeternum.github.io/post-images/%E6%80%A7%E8%83%BD%E6%B5%8B%E9%87%8F/3.png" alt="" loading="lazy"></figure>
<p>关于堆栈的统计，他的应用主要是确保任务堆栈不会栈溢出，而导致影响其他任务或内核资源，但是有为了对资源的良好利用，进而引出了堆栈测量</p>
<p>堆栈统计的方法，大致是把堆栈初始化全部为0，遍历找出为0的，就是未使用的空间；当然，这种方法需要这个任务运行长时间进而运行完所有的情况，因为可能在某个情况下，它开辟了空间，这么统计的就不准确了</p>
<pre><code class="language-c">    info-&gt;stackFree = 0;
    stackEnd = task-&gt;stackBase;
    while ((*stackEnd++ == 0) &amp;&amp; (stackEnd &lt;= task-&gt;stackBase + task-&gt;stackSize / sizeof(tTaskStack)))
    {
        info-&gt;stackFree++;
    }
    // 转换成字节数
    info-&gt;stackFree *= sizeof(tTaskStack);
</code></pre>
<p>在tTaskGetInfo新增以上内容，逻辑是从栈顶往下遍历出0的数量—也需要保证遍历范围不超过栈的大小，最后乘上单位即可，这里的单位也就是定义栈的数据类型</p>
<h1 id="cpu使用百分比测量">CPU使用百分比测量</h1>
<figure data-type="image" tabindex="5"><img src="https://hanaeternum.github.io/post-images/%E6%80%A7%E8%83%BD%E6%B5%8B%E9%87%8F/4.png" alt="" loading="lazy"></figure>
<p>采用的方法是先执行一段程序，时间自定义，单独运行这个代码块获取到计数，定义为Max；后面通过实际运行同样获取到计数，定义为Cnt；大致可以算出来百分比=100 * (1 - Cnt/Max)；这里执行特殊代码块就是空闲任务</p>
<pre><code class="language-c">static float cpuUsage;                      // cpu使用率统计
static uint32_t enableCpuUsageStat;         // 是否使能cpu统计
static void initCpuUsageStat (void)
{
    idleCount = 0;
    idleMaxCount = 0;
    cpuUsage = 0;
    enableCpuUsageStat = 0;
}
static void checkCpuUsage (void)
{
    // 与空闲任务的cpu统计同步
    if (enableCpuUsageStat == 0)
    {
        enableCpuUsageStat = 1;
        tickCount = 0;
        return;
    }
    if (tickCount == TICKS_PER_SEC)
    {
        // 统计最初1s内的最大计数值
        idleMaxCount = idleCount;
        idleCount = 0;
        // 计数完毕，开启调度器，允许切换到其它任务
        tTaskSchedEnable();
    }
    else if (tickCount % TICKS_PER_SEC == 0)
    {
        // 之后每隔1s统计一次，同时计算cpu利用率
        cpuUsage = 100 - (idleCount * 100.0 / idleMaxCount);
        idleCount = 0;
    }
}
static void cpuUsageSyncWithSysTick (void)
{
    // 等待与时钟节拍同步
    while (enableCpuUsageStat == 0)
    {
        ;;
    }
}
float tCpuUsageGet (void)
{
    float usage = 0;
    uint32_t status = tTaskEnterCritical();
    usage = cpuUsage;
    tTaskExitCritical(status);
    return usage;
}
// 用于空闲任务的任务结构和堆栈空间
tTask tTaskIdle;
tTaskStack idleTaskEnv[TINYOS_IDLETASK_STACK_SIZE];
void idleTaskEntry (void * param) {
    // 禁止调度，防止后面在创建任务时切换到其它任务中去
    tTaskSchedDisable();
    // 初始化App相关配置
    tInitApp();
    // 初始化定时器任务
    tTimerInitTask();
    // 启动系统时钟节拍
    tSetSysTickPeriod(TINYOS_SYSTICK_MS);
    // 等待与时钟同步
    cpuUsageSyncWithSysTick();
    for (;;)
    {
        uint32_t status = tTaskEnterCritical();
        idleCount++;
        tTaskExitCritical(status);
    }
}
</code></pre>
<p>这其中最重要的是checkCpuUsage函数，功能是检查CPU使用率，然后通过调用tCpuUsageGet即可查询使用率；首先是与空闲任务的同步，这步是提高精度然后就是分为了两种情况，一种是只执行空闲任务，一种是都执行；最后计算即可</p>
<p>需要注意的是，必须要在滴答定时器中添加以下内容</p>
<pre><code class="language-c">    // 节拍计数增加
    tickCount++;
    // 检查cpu使用率
    checkCpuUsage();
</code></pre>

                </div>
            </article>
        </div>

        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">为颜如玉，为黄金屋，为名满天下，为功利千秋</div>
    <div class="social-container">
        
            
                <a href="https://github.com/hanaeternum" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        
    </div>
    <div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://hanaeternum.github.io/atom.xml" target="_blank">RSS</a></a>
    </div>
</div>

<script>
  hljs.initHighlightingOnLoad()
</script>

    </div>
</div>
</body>
</html>
